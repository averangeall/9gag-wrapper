<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>9GAG Captain Obvious</title>
        <link href="/static/css/bootstrap.min.css" rel="stylesheet" media="screen">
        <script src="http://code.jquery.com/jquery-latest.js"></script>
        <script src="/static/js/bootstrap.min.js"></script>
        <script>
            var uids = new Array();

            function collectUids() {
                var comments = $("[class^=comment-]");
                for(var idx in comments) {
                    if(isNaN(parseInt(idx)))
                        continue;
                    var comment = $(comments[idx]);
                    var className = comment.attr('class');
                    var tokens = className.split('-');
                    var uid = tokens[1];
                    if($.inArray(uid, uids) == -1)
                        uids.push(uid);
                }
            }

            function fillUids() {
                for(var idx in uids) {
                    $.get('/graph/user', {uid: uids[idx]}, function(res) {
                        $('.profile-' + res.uid).attr('src', res.profile);
                        $('.name-' + res.uid).html(res.name);
                    }, 'json');
                }
            }

            function makeGoogleLink(keywords) {
                return 'https://www.google.com.tw/search?q=meme+' + keywords + '&oq=hehe&aqs=chrome.0.57j62.922&sugexp=chrome,mod=14&sourceid=chrome&ie=UTF-8';
            }

            function findMemeClass() {
                $.get('/mc', {gag_id: $('#gag-id').val()}, function(res) {
                    if(res.meme_class == null)
                        $('.meme-class').html('not a meme : (');
                    else {
                        var memeLink = $('<a></a>');
                        memeLink.html(res.meme_class);
                        memeLink.attr('href', makeGoogleLink(res.meme_class));
                        memeLink.attr('target', '_blank');
                        $('.meme-class').html(memeLink);
                    }
                }, 'json');
            }

            function fillGag() {
                $.get('/9gag/post', {gag_id: $('#gag-id').val()}, function(res) {
                    $('#gag-title').html(res.gag_title);
                    $('#gag-img').attr('src', res.gag_img_url);
                    $('#gag-img').attr('class', 'img-polaroid');
                }, 'json');
            }

            function fillComments() {
                $.get('/graph/comments', {gag_id: $('#gag-id').val()}, function(res) {
                    var table = $('#gag-comments');
                    for(var idx in res.comments) {
                        var comment = res.comments[idx];
                        var tr = $('<tr></tr>');
                        tr.attr('class', 'comment-' + comment.uid);
                        var imgProfile = $('<img></img>').attr('src', '/static/img/yao-ming.jpg')
                                                         .attr('class', 'profile-' + comment.uid);
                        var tdProfile = $('<td></td>').attr('width', '60').append(imgProfile);
                        var tdContent = $('<td></td>').append($('<p></p>').attr('class', 'name-' + comment.uid).html('Somebody'))
                                                      .append($('<p></p>').html(comment.content));
                        if(comment.is_lead)
                            tdContent.attr('colspan', '2');
                        else
                            tr.append($('<td></td>'));
                        tr.append(tdProfile);
                        tr.append(tdContent);
                        table.append(tr);
                    }
                    collectUids();
                    fillUids();
                }, 'json');
            }

            $(function() {
                findMemeClass();
                fillGag();
                fillComments();
            });
        </script>
        <style type="text/css">
            body {
                padding-top: 90px;
                padding-bottom: 40px;
            }
        </style>
    </head>
    <body>
        <input type="hidden" id="gag-id" value="{{ gag_id }}" />
        <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="navbar-inner">
            <div class="container">
              <div class="nav-collapse collapse">
                <h1 class="muted">9GAG Captain Obvious</h1>
              </div>
            </div>
          </div>
        </div>

        <div class="container">
            <div>
                <h2 id="gag-title">Loading...</h2>
            </div>
            <div align="right">
                <h3 class="meme-class"><font color="#FFFFFF">determine meme...</font></h3>
            </div>
            <div class="container" style="width: 50%; margin: 0 auto 20px;">
                <img id="gag-img" />
            </div>
            <table id="gag-comments" class="table"></table>
        </div>
    </body>
</html>

